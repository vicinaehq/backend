# Caddyfile for Vicinae Extension Store
# Caddy automatically provisions and renews SSL certificates via Let's Encrypt

{$DOMAIN} {
	# Enable compression
	encode gzip zstd

	# Reverse proxy to Hono app
	reverse_proxy app:3000 {
		# Health check
		health_uri /
		health_interval 30s
		health_timeout 5s

		# Headers
		header_up X-Real-IP {remote_host}
		header_up X-Forwarded-For {remote_host}
		header_up X-Forwarded-Proto {scheme}
	}

	# Security headers
	header {
		# Remove server header
		-Server

		# Security headers
		X-Content-Type-Options "nosniff"
		X-Frame-Options "DENY"
		Referrer-Policy "strict-origin-when-cross-origin"

		# CORS headers for extension downloads
		Access-Control-Allow-Origin "*"
		Access-Control-Allow-Methods "GET, POST, OPTIONS"
		Access-Control-Allow-Headers "Content-Type, Authorization"
	}

	# Rate limiting for uploads (100 requests per minute)
	rate_limit {
		zone upload {
			key {remote_host}
			events 100
			window 1m
		}

		match {
			path /extension/upload
		}
	}

	# Logging
	log {
		output file /data/access.log {
			roll_size 100mb
			roll_keep 5
		}
		format json
	}
}
